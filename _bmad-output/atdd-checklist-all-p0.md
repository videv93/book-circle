# ATDD Checklist - All Epics P0 Risk Areas

**Date:** 2026-02-11
**Author:** vitr
**Primary Test Level:** Unit (Vitest + React Testing Library)

---

## Summary

**Assessment:** The P0 risk areas identified in the test design are **already well-covered** by the existing test suite.

**Test Suite Status:** 1763/1770 tests passing (99.6%), 189/190 files passing

The 7 failing tests are all in `src/actions/admin/getSessionHistory.test.ts` (parseUserAgent tests returning Promises instead of sync values — a minor async bug, not a P0 risk).

---

## P0 Risk Area Coverage Analysis

### R-001: OAuth Session Security (Score: 6)
**Status:** COVERED
- Route protection tested via admin layout/action tests (unauthorized → error)
- Session validation tested in every server action test (pattern: `mockAuth.mockResolvedValue(null)`)
- **Gap:** No direct test of cookie flags (httpOnly, secure, sameSite) — this is framework-level (Better Auth), not application logic

### R-002: Webhook Signature Bypass (Score: 6)
**Status:** COVERED (7 tests)
- File: `src/app/api/webhooks/polar/route.test.ts`
- Tests: Valid signature → 200, Invalid signature → 401, No DB changes on invalid sig
- Idempotency: Duplicate webhook → no duplicate records

### R-003: Streak Timezone Edge Cases (Score: 6)
**Status:** COVERED (15+ tests)
- File: `src/actions/streaks/updateStreakOnGoalMet.test.ts`
- File: `src/lib/dates.test.ts`
- Tests: UTC bounds, US/Eastern, Asia/Tokyo, timezone boundary crossings, DST-safe 24h spans
- Streak logic: consecutive day, missed day, freeze continuation, idempotency, multi-day gap

### R-004: Presence Polling Performance (Score: 6)
**Status:** PARTIALLY COVERED
- Presence actions have unit tests for happy paths
- **Gap:** No load/performance tests for concurrent users — acceptable for MVP scale (100 concurrent)

### R-005: Payment→Premium Race Condition (Score: 6)
**Status:** COVERED (7 tests)
- File: `src/app/api/webhooks/polar/route.test.ts`
- Tests: Atomic transaction for paid orders, idempotency check, unpaid → no upgrade
- Transaction mock verifies both Payment creation and User upgrade happen atomically

### R-006: Admin Authorization (Score: 6)
**Status:** COVERED (12+ tests)
- File: `src/lib/admin.test.ts` — role checks, env fallback, priority
- Admin server actions test unauthorized/forbidden paths
- **Gap:** No integration test of admin layout redirect — acceptable as layout is thin wrapper

---

## Existing Test Files for P0 Areas

| Risk | Test File | Test Count | Status |
|------|-----------|------------|--------|
| R-002 | `src/app/api/webhooks/polar/route.test.ts` | 7 | All passing |
| R-003 | `src/actions/streaks/updateStreakOnGoalMet.test.ts` | 15 | All passing |
| R-003 | `src/lib/dates.test.ts` | 10 | All passing |
| R-005 | `src/app/api/webhooks/polar/route.test.ts` | (same 7) | All passing |
| R-006 | `src/lib/admin.test.ts` | 12 | All passing |
| R-001 | Various server action tests | 50+ | All passing |
| R-008 | `src/actions/books/addToLibrary.test.ts` | 10+ | All passing |

---

## Remaining Gaps (P1/P2 — Not Blocking)

1. **parseUserAgent async bug** (7 failing tests) — function likely changed from sync to async but tests not updated
2. **Admin layout redirect test** — thin server component, low risk
3. **Presence load testing** — not critical for MVP scale
4. **E2E tests** — no Playwright setup; entire app lacks E2E coverage (future initiative)

---

## Red-Green-Refactor Status

### RED Phase: N/A
All P0 tests already exist and pass. No new failing tests needed.

### GREEN Phase: COMPLETE
P0 risk areas have passing tests covering the critical scenarios.

### REFACTOR Phase: RECOMMENDED
1. **Fix parseUserAgent tests** — 7 easy fixes (add `await` or update to sync)
2. **Consider adding DST transition test** for streak logic (March/November clock change)

---

## Running Tests

```bash
# Run all tests
npm run test:run

# Run P0-specific test files
npx vitest run src/app/api/webhooks/polar/route.test.ts
npx vitest run src/actions/streaks/updateStreakOnGoalMet.test.ts
npx vitest run src/lib/dates.test.ts
npx vitest run src/lib/admin.test.ts
npx vitest run src/actions/books/addToLibrary.test.ts

# Run failing tests only (parseUserAgent bug)
npx vitest run src/actions/admin/getSessionHistory.test.ts
```

---

## Recommendation

The P0 risk areas are **adequately covered**. The BMad Master recommends:

1. **Fix the 7 parseUserAgent test failures** (quick fix — async/await issue)
2. **Proceed to implementation-readiness check** (`/bmad:bmm:workflows:check-implementation-readiness`)
3. **Defer E2E test setup** to Sprint 0 of implementation phase

---

**Generated by BMad Master (TEA ATDD workflow)** - 2026-02-11
